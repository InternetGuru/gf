language: bash
dist: trusty
sudo: false

addons:
  apt:
    sources:
    - debian-sid # Needed for shellcheck
    packages:
    - shellcheck
    - python-docutils # Needed for rst2man
    - jq # Needed for parsing response from GitHub API

env:
  - DIST=regular DEPLOY_FILE=gf-*.tar.gz
  - DIST=single DEPLOY_FILE=gf.sh

before_install:
  - export PREFIX=$HOME/opt
  - mkdir -p $PREFIX/bin
  - export PATH=$PREFIX/bin:$PATH

install:
  # Install latest release of BUTT for Bash testing
  - |
    wget $(\
      curl -s https://api.github.com/repos/Internetguru/butt/releases/latest \
      | jq -r ".assets[] \
      | .browser_download_url" \
      | grep \.sh$) -O $PREFIX/bin/butt
  - chmod +x $PREFIX/bin/butt

before_script:
  - |
    if [[ $DIST == regular ]]; then
      ./configure \
        && make \
        && cat compiled/install \
        && compiled/install \
        && PREFIX=/usr/local make dist
    fi
  - |
    if [[ $DIST == single ]]; then
      ./configure \
        && make distsingle \
        && cp gf.sh $PREFIX/bin/gf
    fi

script:
 - shellcheck gf
 - butt -w test test/test.butt

matrix:
  fast_finish: true
